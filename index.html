<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Divergent Reading Notes - Four Quadrant Method</title>

  <style>
    :root{
      --bg:#f7f6f2;
      --ink:#23302a;
      --muted:#5d6b63;
      --line:rgba(24,40,32,.14);

      --paper:rgba(255,250,246,.92);

      --active-border:rgba(80,160,120,.55);
      --shadow:0 10px 28px rgba(18,28,22,.14);
      --radius:18px;

      --sidebar-w:320px;
      --sidebar-collapsed-w:54px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--ink);
      background:var(--bg);
      background-image:
        linear-gradient(rgba(247,246,242,.93),rgba(247,246,242,.93)),
        url("assets/botanical.png");
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
    }

    .app{
      max-width:1400px;
      margin:20px auto;
      padding:0 18px 26px;
      display:flex;
      gap:14px;
      align-items:flex-start;
    }

    /* Sidebar */
    .sidebar{
      width:var(--sidebar-w);
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(255,255,255,.80);
      box-shadow:var(--shadow);
      backdrop-filter:blur(6px);
      overflow:hidden;
      transition:width .2s ease;
      position:sticky;
      top:16px;
      max-height:calc(100vh - 32px);
      display:flex;
      flex-direction:column;
    }

    .sidebar.collapsed{
      width:var(--sidebar-collapsed-w);
    }

    .sidebarHeader{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(90deg,rgba(207,233,214,.45),rgba(246,215,223,.35));
    }

    .sideToggle{
      width:34px;
      height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.88);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:transform .08s ease,filter .12s ease;
      flex:0 0 auto;
    }

    .sideToggle:active{ transform:translateY(1px); }

    .sidebarTitle{
      font-size:14px;
      font-weight:700;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex:1 1 auto;
    }

    .sidebar.collapsed .sidebarTitle{ display:none; }

    .sideTools{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }

    .sidebar.collapsed .sideTools{ display:none; }

    .sideTools button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.88);
      border-radius:12px;
      padding:8px 10px;
      font-size:13px;
      cursor:pointer;
    }

    .noteList{
      padding:8px;
      overflow:auto;
    }

    .sidebar.collapsed .noteList{ display:none; }

    .noteItem{
      border:1px solid rgba(24,40,32,.10);
      background:rgba(255,250,246,.90);
      border-radius:14px;
      padding:10px 10px;
      margin:8px 0;
      cursor:pointer;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      transition:filter .12s ease,transform .12s ease,border-color .12s ease;
    }

    .noteItem:hover{ filter:brightness(.985); }

    .noteItem:active{ transform:translateY(1px); }

    .noteItem.active{
      border-color:rgba(80,160,120,.45);
      box-shadow:0 10px 22px rgba(18,28,22,.10);
    }

    .noteMeta{
      min-width:0;
      flex:1 1 auto;
    }

    .noteLine1{
      font-size:13px;
      font-weight:700;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .noteLine2{
      font-size:12px;
      color:var(--muted);
      margin:4px 0 0;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      border:1px solid rgba(24,40,32,.12);
      background:rgba(255,255,255,.60);
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
    }

    .pinBtn{
      border:1px solid rgba(24,40,32,.12);
      background:rgba(255,255,255,.80);
      border-radius:12px;
      padding:6px 8px;
      font-size:12px;
      cursor:pointer;
      flex:0 0 auto;
      line-height:1;
    }

    /* Main */
    .main{
      flex:1 1 auto;
      min-width:0;
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(255,255,255,.84);
      box-shadow:var(--shadow);
      backdrop-filter:blur(6px);
    }

    .brand h1{
      font-size:20px;
      margin:0;
      letter-spacing:.2px;
    }

    .brand p{
      margin:2px 0 0;
      color:var(--muted);
      font-size:13px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }

    button, select, input{
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      color:var(--ink);
    }

    button{
      cursor:pointer;
      transition:transform .08s ease,filter .12s ease;
    }

    button:hover{ filter:brightness(.985); }

    button:active{ transform:translateY(1px); }

    .btn-soft{
      background:linear-gradient(180deg,rgba(246,215,223,.9),rgba(207,233,214,.9));
      border-color:rgba(90,130,110,.25);
    }

    .meta{
      margin-top:14px;
      display:grid;
      grid-template-columns:2fr 1fr 1fr 1fr 1.2fr;
      gap:12px;
      align-items:center;
    }

    .meta input, .meta select{
      width:100%;
      background:rgba(255,255,255,.86);
    }

    .chapterWrap{
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      border-radius:12px;
      padding:8px 10px;
      min-height:42px;
    }

    .chapterWrap input[type="number"]{
      width:90px;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(255,255,255,.92);
    }

    .chapterWrap input[type="range"]{
      width:100%;
      accent-color:rgba(110,175,140,.9);
    }

    .board{
      margin-top:14px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:var(--paper);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:260px;
      transition:background .18s ease,border-color .18s ease,transform .12s ease,box-shadow .18s ease;
    }

    .card header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(90deg,rgba(207,233,214,.45),rgba(246,215,223,.35));
    }

    .card header h2{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }

    .hint{
      color:var(--muted);
      font-size:12px;
    }

    .editor{
      padding:14px;
      min-height:200px;
      line-height:1.55;
      outline:none;
      white-space:pre-wrap;
    }

    .card.active{
      background:linear-gradient(180deg,rgba(223,243,234,.65),rgba(255,250,246,.92));
      border-color:var(--active-border);
      box-shadow:0 14px 34px rgba(18,28,22,.18);
      transform:translateY(-1px);
    }

    .footer{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      text-align:right;
      padding:0 4px;
    }

    .gridline{
      position:relative;
    }

    .gridline:before, .gridline:after{
      content:"";
      position:absolute;
      background:rgba(35,48,42,.08);
      pointer-events:none;
      border-radius:999px;
    }

    .gridline:before{
      top:calc(50% - 1px);
      left:0;
      right:0;
      height:2px;
    }

    .gridline:after{
      left:calc(50% - 1px);
      top:0;
      bottom:0;
      width:2px;
    }

    @media (max-width:1100px){
      .app{ flex-direction:column; }
      .sidebar{ position:relative; top:0; width:100%; }
      .sidebar.collapsed{ width:100%; }
      .sidebar.collapsed .noteList{ display:block; }
      .sidebar.collapsed .sidebarTitle{ display:block; }
      .meta{ grid-template-columns:1fr 1fr; }
      .board{ grid-template-columns:1fr; }
      .gridline:after{ display:none; }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside id="sidebar" class="sidebar">
      <div class="sidebarHeader">
        <button id="sideToggle" class="sideToggle" type="button" aria-label="toggle sidebar">â—€</button>
        <h3 class="sidebarTitle" data-i18n="sideTitle">Chapter Notes</h3>
        <div class="sideTools">
          <button id="sideSortBtn" type="button" data-i18n="sideSort">Time</button>
        </div>
      </div>
      <div id="noteList" class="noteList"></div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="brand">
          <h1 data-i18n="titleMain">Divergent Reading Notes</h1>
          <p data-i18n="titleSub">Four Quadrant Method (Quotes / Summary / Reflections / Connections)</p>
        </div>

        <div class="actions">
          <button id="langBtn" class="btn-soft" type="button" aria-label="language toggle">EN</button>

          <select id="noteSelect" aria-label="note list"></select>
          <button id="newBtn" type="button" data-i18n="btnNew">New</button>
          <button id="saveBtn" type="button" data-i18n="btnSave">Save</button>
          <button id="exportBtn" type="button" data-i18n="btnExport">Export</button>
          <button id="importBtn" type="button" data-i18n="btnImport">Import</button>
          <button id="deleteBtn" type="button" data-i18n="btnDelete">Delete</button>
        </div>
      </div>

      <div class="meta">
        <input id="bookTitle" placeholder="Book Title">
        <input id="author" placeholder="Author">
        <input id="date" type="date" aria-label="date">
        <input id="tags" placeholder="Tags">

        <div class="chapterWrap" aria-label="chapter">
          <input id="chapterNum" type="number" min="1" step="1" value="1" aria-label="chapter number">
          <input id="chapterRange" type="range" min="1" max="200" step="1" value="1" aria-label="chapter slider">
        </div>
      </div>

      <div class="board gridline">
        <section class="card" data-card="q1">
          <header>
            <h2 data-i18n="q1Title">Quotes & Excerpts</h2>
            <span class="hint" data-i18n="q1Hint">Anchor lines, questions, objections</span>
          </header>
          <div id="q1" class="editor" contenteditable="true"></div>
        </section>

        <section class="card" data-card="q2">
          <header>
            <h2 data-i18n="q2Title">Summary & Insights</h2>
            <span class="hint" data-i18n="q2Hint">Themes, structure, style, key points</span>
          </header>
          <div id="q2" class="editor" contenteditable="true"></div>
        </section>

        <section class="card" data-card="q3">
          <header>
            <h2 data-i18n="q3Title">Reflections & Feelings</h2>
            <span class="hint" data-i18n="q3Hint">Personal reactions, judgments, emotions</span>
          </header>
          <div id="q3" class="editor" contenteditable="true"></div>
        </section>

        <section class="card" data-card="q4">
          <header>
            <h2 data-i18n="q4Title">Connections & Associations</h2>
            <span class="hint" data-i18n="q4Hint">Links, contrasts, real life, other works</span>
          </header>
          <div id="q4" class="editor" contenteditable="true"></div>
        </section>
      </div>

      <div class="footer">
        <span id="status" data-i18n="statusReady">Ready</span>
      </div>
    </main>
  </div>

  <input id="fileInput" type="file" accept="application/json" style="display:none">

  <script>
    const LS_KEY="drn_notes_v3";
    const LS_LANG="drn_lang";
    const LS_SIDEBAR="drn_sidebar";
    const LS_SORT="drn_sort";

    const i18n={
      en:{
        titleMain:"Divergent Reading Notes",
        titleSub:"Four Quadrant Method (Quotes / Summary / Reflections / Connections)",

        btnNew:"New",
        btnSave:"Save",
        btnExport:"Export",
        btnImport:"Import",
        btnDelete:"Delete",

        phBookTitle:"Book Title",
        phAuthor:"Author",
        phTags:"Tags",

        q1Title:"Quotes & Excerpts",
        q1Hint:"Anchor lines, questions, objections",
        q2Title:"Summary & Insights",
        q2Hint:"Themes, structure, style, key points",
        q3Title:"Reflections & Feelings",
        q3Hint:"Personal reactions, judgments, emotions",
        q4Title:"Connections & Associations",
        q4Hint:"Links, contrasts, real life, other works",

        sideTitle:"Chapter Notes",
        sideSort:"Time",

        statusReady:"Ready",
        statusLoaded:"Loaded",
        statusSaved:"Saved",
        statusNew:"New note created",
        statusDeleted:"Deleted",
        statusExported:"Exported",
        statusImported:"Imported",
        statusImportFailed:"Import failed",
        statusInvalidFile:"Invalid file",

        pin:"Pin",
        unpin:"Unpin",
        noTime:"No time",
        untitled:"Untitled",
        chPrefix:"Ch "
      },
      zh:{
        titleMain:"å‘æ•£å¼è¯»ä¹¦ç¬”è®°",
        titleSub:"å››è±¡é™è®°å½•æ³•ï¼ˆæ‘˜å½• / æ‘˜è¦ / æ„Ÿæƒ³ / è”æƒ³ï¼‰",

        btnNew:"æ–°å»º",
        btnSave:"ä¿å­˜",
        btnExport:"å¯¼å‡º",
        btnImport:"å¯¼å…¥",
        btnDelete:"åˆ é™¤",

        phBookTitle:"ä¹¦å",
        phAuthor:"ä½œè€…",
        phTags:"æ ‡ç­¾",

        q1Title:"æ‘˜å½•",
        q1Hint:"åŽŸå¥é”šç‚¹ã€ç–‘é—®ç‚¹ã€å¼‚è®®ç‚¹",
        q2Title:"æ‘˜è¦",
        q2Hint:"ä¸»é¢˜ã€ç»“æž„ã€é£Žæ ¼ã€è¦ç‚¹",
        q3Title:"æ„Ÿæƒ³",
        q3Hint:"ä¸ªäººè§¦åŠ¨ã€åˆ¤æ–­ã€æƒ…ç»ª",
        q4Title:"è”æƒ³",
        q4Hint:"å…³è”ä½œå“ã€å¯¹æ¯”ã€çŽ°å®žæ˜ å°„",

        sideTitle:"ç« èŠ‚è®°å½•",
        sideSort:"æ—¶é—´",

        statusReady:"å°±ç»ª",
        statusLoaded:"å·²åŠ è½½",
        statusSaved:"å·²ä¿å­˜",
        statusNew:"å·²æ–°å»º",
        statusDeleted:"å·²åˆ é™¤",
        statusExported:"å·²å¯¼å‡º",
        statusImported:"å·²å¯¼å…¥",
        statusImportFailed:"å¯¼å…¥å¤±è´¥",
        statusInvalidFile:"æ–‡ä»¶æ— æ•ˆ",

        pin:"ç½®é¡¶",
        unpin:"å–æ¶ˆç½®é¡¶",
        noTime:"æ— æ—¶é—´",
        untitled:"æœªå‘½å",
        chPrefix:"ç¬¬"
      }
    };

    const els={
      sidebar:document.getElementById("sidebar"),
      sideToggle:document.getElementById("sideToggle"),
      noteList:document.getElementById("noteList"),
      sideSortBtn:document.getElementById("sideSortBtn"),

      langBtn:document.getElementById("langBtn"),
      noteSelect:document.getElementById("noteSelect"),
      newBtn:document.getElementById("newBtn"),
      saveBtn:document.getElementById("saveBtn"),
      exportBtn:document.getElementById("exportBtn"),
      importBtn:document.getElementById("importBtn"),
      deleteBtn:document.getElementById("deleteBtn"),
      fileInput:document.getElementById("fileInput"),
      status:document.getElementById("status"),

      bookTitle:document.getElementById("bookTitle"),
      author:document.getElementById("author"),
      date:document.getElementById("date"),
      tags:document.getElementById("tags"),

      chapterNum:document.getElementById("chapterNum"),
      chapterRange:document.getElementById("chapterRange"),

      q1:document.getElementById("q1"),
      q2:document.getElementById("q2"),
      q3:document.getElementById("q3"),
      q4:document.getElementById("q4")
    };

    function nowIso(){ return new Date().toISOString(); }

    function uid(){
      return "n_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16);
    }

    function loadDB(){
      const raw=localStorage.getItem(LS_KEY);
      if(!raw) return {activeId:null,notes:{}};
      try{ return JSON.parse(raw); }catch{ return {activeId:null,notes:{}}; }
    }

    function saveDB(db){
      localStorage.setItem(LS_KEY,JSON.stringify(db));
    }

    function getLang(){
      const v=localStorage.getItem(LS_LANG);
      if(v==="zh"||v==="en") return v;
      return "en";
    }

    function setLang(lang){
      localStorage.setItem(LS_LANG,lang);
      applyLang();
    }

    function dict(){
      const lang=getLang();
      return i18n[lang]||i18n.en;
    }

    function setStatusKey(key){
      const d=dict();
      els.status.textContent=d[key]||i18n.en[key]||"";
    }

    function safeInt(v,fallback){
      const x=parseInt(v,10);
      if(Number.isFinite(x)&&x>=1) return x;
      return fallback;
    }

    function noteTitleForSelect(n){
      const d=dict();
      const t=(n.bookTitle||"").trim()||d.untitled;
      const ch=safeInt(n.chapter,1);
      const lang=getLang();
      if(lang==="zh") return t+" Â· ç¬¬"+ch+"ç« ";
      return t+" Â· "+d.chPrefix+ch;
    }

    function readForm(){
      return {
        bookTitle:els.bookTitle.value,
        author:els.author.value,
        date:els.date.value,
        tags:els.tags.value,
        chapter:safeInt(els.chapterNum.value,1),
        q1:els.q1.innerText,
        q2:els.q2.innerText,
        q3:els.q3.innerText,
        q4:els.q4.innerText
      };
    }

    function writeForm(n){
      els.bookTitle.value=n.bookTitle||"";
      els.author.value=n.author||"";
      els.date.value=n.date||"";
      els.tags.value=n.tags||"";

      const ch=safeInt(n.chapter,1);
      els.chapterNum.value=ch;
      els.chapterRange.value=String(ch);

      els.q1.innerText=n.q1||"";
      els.q2.innerText=n.q2||"";
      els.q3.innerText=n.q3||"";
      els.q4.innerText=n.q4||"";
    }

    function ensureOneNote(db){
      if(Object.keys(db.notes).length) return db;

      const id=uid();
      db.notes[id]={
        id,
        createdAt:nowIso(),
        updatedAt:nowIso(),
        pinned:false,
        bookTitle:"",
        author:"",
        date:"",
        tags:"",
        chapter:1,
        q1:"",
        q2:"",
        q3:"",
        q4:""
      };
      db.activeId=id;
      saveDB(db);
      return db;
    }

    function getActive(db){
      return db.notes[db.activeId];
    }

    function getSortMode(){
      const v=localStorage.getItem(LS_SORT);
      if(v==="updatedAt"||v==="createdAt") return v;
      return "updatedAt";
    }

    function setSortMode(mode){
      localStorage.setItem(LS_SORT,mode);
    }

    function getSortedNoteIds(db){
      const sortKey=getSortMode();
      const ids=Object.keys(db.notes);

      ids.sort((a,b)=>{
        const A=db.notes[a];
        const B=db.notes[b];

        const ap=A.pinned?1:0;
        const bp=B.pinned?1:0;
        if(ap!==bp) return bp-ap;

        const ta=A[sortKey]||"";
        const tb=B[sortKey]||"";
        return tb.localeCompare(ta);
      });

      return ids;
    }

    function refreshSelect(db){
      const ids=getSortedNoteIds(db);
      els.noteSelect.innerHTML="";

      for(const id of ids){
        const opt=document.createElement("option");
        opt.value=id;
        opt.textContent=noteTitleForSelect(db.notes[id]);
        els.noteSelect.appendChild(opt);
      }

      if(db.activeId && db.notes[db.activeId]){
        els.noteSelect.value=db.activeId;
      }else if(ids.length){
        db.activeId=ids[0];
        els.noteSelect.value=db.activeId;
        saveDB(db);
      }
    }

    function renderSidebar(db){
      const d=dict();
      const lang=getLang();
      const ids=getSortedNoteIds(db);

      els.noteList.innerHTML="";

      for(const id of ids){
        const n=db.notes[id];

        const item=document.createElement("div");
        item.className="noteItem"+(id===db.activeId?" active":"");
        item.dataset.id=id;

        const meta=document.createElement("div");
        meta.className="noteMeta";

        const title=document.createElement("p");
        title.className="noteLine1";
        title.textContent=(n.bookTitle||"").trim()||d.untitled;

        const line2=document.createElement("div");
        line2.className="noteLine2";

        const ch=document.createElement("span");
        ch.className="pill";
        const chNum=safeInt(n.chapter,1);
        ch.textContent=(lang==="zh" ? ("ç¬¬"+chNum+"ç« ") : ("Ch "+chNum));

        const time=document.createElement("span");
        time.className="pill";
        const key=getSortMode();
        const t=n[key] ? new Date(n[key]) : null;
        time.textContent=t ? t.toLocaleString() : d.noTime;

        line2.appendChild(ch);
        line2.appendChild(time);

        meta.appendChild(title);
        meta.appendChild(line2);

        const pin=document.createElement("button");
        pin.className="pinBtn";
        pin.type="button";
        pin.textContent=n.pinned ? "ðŸ“Œ" : "ðŸ“";
        pin.title=n.pinned ? d.unpin : d.pin;

        pin.addEventListener("click",(ev)=>{
          ev.stopPropagation();
          const db2=loadDB();
          if(!db2.notes[id]) return;
          db2.notes[id].pinned=!db2.notes[id].pinned;
          db2.notes[id].updatedAt=nowIso();
          saveDB(db2);
          refreshSelect(db2);
          renderSidebar(db2);
        });

        item.addEventListener("click",()=>{
          const db2=loadDB();
          db2.activeId=id;
          saveDB(db2);
          refreshSelect(db2);
          renderSidebar(db2);
          writeForm(db2.notes[id]);
          setStatusKey("statusLoaded");
        });

        item.appendChild(meta);
        item.appendChild(pin);

        els.noteList.appendChild(item);
      }

      const sortKey=getSortMode();
      els.sideSortBtn.textContent=(getLang()==="zh"
        ? (sortKey==="updatedAt" ? "æŒ‰æ›´æ–°" : "æŒ‰åˆ›å»º")
        : (sortKey==="updatedAt" ? "Updated" : "Created"));
    }

    function persistActive(db){
      const n=getActive(db);
      if(!n) return;

      const v=readForm();
      n.bookTitle=v.bookTitle;
      n.author=v.author;
      n.date=v.date;
      n.tags=v.tags;
      n.chapter=v.chapter;

      n.q1=v.q1;
      n.q2=v.q2;
      n.q3=v.q3;
      n.q4=v.q4;

      n.updatedAt=nowIso();
      saveDB(db);

      refreshSelect(db);
      renderSidebar(db);
      setStatusKey("statusSaved");
    }

    function applyLang(){
      const d=dict();
      document.documentElement.lang=getLang();

      document.querySelectorAll("[data-i18n]").forEach(node=>{
        const key=node.getAttribute("data-i18n");
        if(d[key]!=null) node.textContent=d[key];
      });

      els.bookTitle.placeholder=d.phBookTitle;
      els.author.placeholder=d.phAuthor;
      els.tags.placeholder=d.phTags;

      els.langBtn.textContent=(getLang()==="zh" ? "ä¸­æ–‡" : "EN");

      db=loadDB();
      refreshSelect(db);
      renderSidebar(db);
      setStatusKey("statusReady");
    }

    function loadSidebarState(){
      const v=localStorage.getItem(LS_SIDEBAR);
      if(v==="collapsed") els.sidebar.classList.add("collapsed");
      els.sideToggle.textContent=els.sidebar.classList.contains("collapsed") ? "â–¶" : "â—€";
    }

    function toggleSidebar(){
      els.sidebar.classList.toggle("collapsed");
      const collapsed=els.sidebar.classList.contains("collapsed");
      localStorage.setItem(LS_SIDEBAR,collapsed ? "collapsed" : "open");
      els.sideToggle.textContent=collapsed ? "â–¶" : "â—€";
    }

    function clampChapterToRange(){
      const min=parseInt(els.chapterRange.min,10);
      const max=parseInt(els.chapterRange.max,10);
      let v=safeInt(els.chapterNum.value,1);
      v=Math.min(Math.max(v,min),max);
      els.chapterNum.value=v;
      els.chapterRange.value=String(v);
    }

    function clearActiveCards(){
      document.querySelectorAll(".card").forEach(c=>c.classList.remove("active"));
    }

    function setActiveCardByEditor(editorEl){
      const card=editorEl.closest(".card");
      if(!card) return;
      clearActiveCards();
      card.classList.add("active");
    }

    let db=ensureOneNote(loadDB());
    refreshSelect(db);
    writeForm(getActive(db));

    loadSidebarState();
    applyLang();
    renderSidebar(loadDB());

    els.langBtn.addEventListener("click",()=>{
      setLang(getLang()==="en" ? "zh" : "en");
    });

    els.sideToggle.addEventListener("click",toggleSidebar);

    els.sideSortBtn.addEventListener("click",()=>{
      const cur=getSortMode();
      const next=(cur==="updatedAt" ? "createdAt" : "updatedAt");
      setSortMode(next);
      db=loadDB();
      refreshSelect(db);
      renderSidebar(db);
    });

    els.noteSelect.addEventListener("change",()=>{
      db=loadDB();
      db.activeId=els.noteSelect.value;
      saveDB(db);
      writeForm(getActive(db));
      renderSidebar(db);
      setStatusKey("statusLoaded");
    });

    els.newBtn.addEventListener("click",()=>{
      db=loadDB();
      const id=uid();
      db.notes[id]={
        id,
        createdAt:nowIso(),
        updatedAt:nowIso(),
        pinned:false,
        bookTitle:"",
        author:"",
        date:"",
        tags:"",
        chapter:1,
        q1:"",
        q2:"",
        q3:"",
        q4:""
      };
      db.activeId=id;
      saveDB(db);
      refreshSelect(db);
      renderSidebar(db);
      writeForm(getActive(db));
      setStatusKey("statusNew");
    });

    els.saveBtn.addEventListener("click",()=>{
      db=loadDB();
      persistActive(db);
    });

    els.deleteBtn.addEventListener("click",()=>{
      db=loadDB();
      const id=db.activeId;
      if(!id) return;

      delete db.notes[id];
      db.activeId=null;
      saveDB(db);

      db=ensureOneNote(loadDB());
      refreshSelect(db);
      renderSidebar(db);
      writeForm(getActive(db));
      setStatusKey("statusDeleted");
    });

    els.exportBtn.addEventListener("click",()=>{
      db=loadDB();
      persistActive(db);

      const blob=new Blob([JSON.stringify(db,null,2)],{type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="divergent-reading-notes.json";
      a.click();
      URL.revokeObjectURL(a.href);
      setStatusKey("statusExported");
    });

    els.importBtn.addEventListener("click",()=>{
      els.fileInput.value="";
      els.fileInput.click();
    });

    els.fileInput.addEventListener("change",async ()=>{
      const f=els.fileInput.files && els.fileInput.files[0];
      if(!f) return;

      const text=await f.text();
      let incoming;
      try{ incoming=JSON.parse(text); }catch{ setStatusKey("statusImportFailed"); return; }

      if(!incoming || typeof incoming!=="object" || !incoming.notes){
        setStatusKey("statusInvalidFile");
        return;
      }

      saveDB(incoming);
      db=ensureOneNote(loadDB());
      refreshSelect(db);
      renderSidebar(db);
      writeForm(getActive(db));
      setStatusKey("statusImported");
    });

    els.chapterNum.addEventListener("input",()=>{
      clampChapterToRange();
      scheduleAutosave();
    });

    els.chapterRange.addEventListener("input",()=>{
      els.chapterNum.value=els.chapterRange.value;
      scheduleAutosave();
    });

    let t=null;
    function scheduleAutosave(){
      if(t) clearTimeout(t);
      t=setTimeout(()=>{
        db=loadDB();
        persistActive(db);
      },900);
    }

    [els.bookTitle,els.author,els.date,els.tags].forEach(x=>x.addEventListener("input",scheduleAutosave));
    [els.q1,els.q2,els.q3,els.q4].forEach(x=>x.addEventListener("input",scheduleAutosave));

    [els.q1,els.q2,els.q3,els.q4].forEach(ed=>{
      ed.addEventListener("focus",()=>setActiveCardByEditor(ed));
      ed.addEventListener("click",()=>setActiveCardByEditor(ed));
      ed.addEventListener("blur",()=>clearActiveCards());
    });

    document.addEventListener("click",(ev)=>{
      const isEditor=ev.target && ev.target.classList && ev.target.classList.contains("editor");
      if(!isEditor) clearActiveCards();
    });
  </script>
</body>
</html>
